{% extends "post_login_loans.html" %}
{% block content %}

<body>
    <div id="demandList">
    </div>
</body>

<script>
        var source = "/rawDemandsByLoan/{{loan_id}}";
        $.ajax({
            type: 'GET',
            url: source,
            contentType: "application/json",
            dataType: 'json',
            success: function (json) {
                console.log(json);
                    {
                        if (json[0]['closing_balance_principal_due'] === null) {
                                json[0]['opening_balance_principal_due'] = 0;
                                json[0]['opening_balance_interest_due'] = 0;
                                json[0]['opening_balance_principal_ndue'] = parseInt(json[0]['loan_amount']);
                        }

                        for(var i = 0; i<json.length; i++) {
                            json[i]['demand_number'] = parseInt(json[i]['demand_number']);
                            if (i !== 0 ) {
                                json[i]['opening_balance_principal_due'] = parseInt(json[i-1]['closing_balance_principal_due']);
                                json[i]['opening_balance_interest_due'] = parseInt(json[i-1]['closing_balance_interest_due']);
                                json[i]['opening_balance_principal_ndue'] = parseInt(json[i-1]['closing_balance_principal_ndue']);
                            }

                            if(json[i]["cheque_date"] !== null) {
                                json[i]["cheque_date"] = moment(json[i]["cheque_date"]['$date']).format('YYYY-MM-DD');
                            }

                            if(json[i]["demand_date"] !== null) {
                                json[i]["demand_date"] = moment(json[i]["demand_date"]['$date']).format('YYYY-MM-DD');
                            }

                            if(moment(json[i]['demand_date']).isValid()) {
                                if(moment(json[i]['demand_date']).isBefore(moment()) && json[i]['principal_collected'] === null) {
                                    json[i]['cheque_date'] = moment();
                                    json[i]['Total Principal Demand'] = parseInt(json[i]['principal_demand'])+parseInt(json[i]['opening_balance_principal_due']);
                                    json[i]['Total Interest Demand'] = parseInt(json[i]['interest_demand'])+parseInt(json[i]['opening_balance_interest_due']);
                                    json[i]['Total Demand'] = json[i]['Total Principal Demand']+json[i]['Total Interest Demand'];
                                    if(json[i]['demand_number'] === 1) {
                                        var delay = moment().diff(moment(json[i]['demand_date']), 'days');
                                        json[i]['delay'] = delay;
                                        json[i]['penal_interest'] = (delay*json[i]['Total Demand']*5)/(365*100);
                                        json[i]['belated_interest'] = (delay*json[i]['Total Demand']*parseInt(json[i]['roi']))/(365*100);
                                    }
                                    else {
                                        json[i]['opening_balance_due'] = json[i]['opening_balance_principal_due']+json[i]['opening_balance_interest_due'];
                                        var delay_old = moment(json[i]['demand_date']).diff(moment(json[i-1]['cheque_date']), 'days');
                                        json[i]['delay_old'] = delay_old;
                                        json[i]['penal_interest_old'] = (delay_old*json[i]['opening_balance_due']*5)/(365*100);
                                        json[i]['belated_interest_old'] = (delay_old*json[i]['opening_balance_due']*parseInt(json[i]['roi']))/(365*100);

                                        delay = moment().diff(moment(json[i]['demand_date']), 'days');
                                        json[i]['penal_interest'] = (delay*json[i]['Total Demand']*5)/(365*100);
                                        json[i]['delay'] = delay;
                                        json[i]['belated_interest'] = (delay*json[i]['Total Demand']*parseInt(json[i]['roi']))/(365*100);

                                        json[i]['penal_interest'] += json[i]['penal_interest_old'];
                                        json[i]['belated_interest'] += json[i]['belated_interest_old'];
                                    }
                                    json[i]['Remarks'] = "Demand Payment not yet made; Penal Interest shown if payment is made today";
                                    json[i]['closing_balance_principal_due'] = parseInt(json[i]['Total Principal Demand']);
                                    json[i]['closing_balance_interest_due'] = parseInt(json[i]['Total Interest Demand']);
                                    json[i]['closing_balance_principal_ndue'] = parseInt(json[i]['loan_amount'])-parseInt(json[i]['Total Principal Demand']);
                                }
                            }
                        }

                        var tbl = $("<table class='table table-bordered table-dark' id='demandDetails'/>");
                        $("#demandList").append(tbl);
                        var hr = "<tr>";
                        var th1 = "<th style='text-align:center;vertical-align:middle'>" + "Demand Number" + "</th>";
                        var th2 = "<th style='text-align:center;vertical-align:middle'>" + "Demand Date" + "</th>";
                        var th3 = "<th style='text-align:center;vertical-align:middle'>" + "Cheque Date" + "</th>";
                        var th4 = "<th style='text-align:center;vertical-align:middle'>" + "Loan Amount" + "</th>";
                        var th5 = "<th style='text-align:center;vertical-align:middle'>" + "Belated Interest" + "</th>";
                        var th6 = "<th style='text-align:center;vertical-align:middle'>" + "Penal Interest" + "</th>";
                        var th7 = "<th style='text-align:center;vertical-align:middle'>" + "Principal Due" + "</th>";
                        var th8 = "<th style='text-align:center;vertical-align:middle'>" + "Interest Due" + "</th>";
                        var th9 = "<th style='text-align:center;vertical-align:middle'>" + "Edit Application" + "</th>";
                        var th10 = "<th style='text-align:center;vertical-align:middle'>" + "Remarks" + "</th>";
                        var th11 = "<th style='text-align:center;vertical-align:middle'>" + "Download Receipt" + "</th>";
                        $("#demandDetails").append(hr + th1 + th2 + th3 + th4 + th5 + th6 + th7 + th8 + th9 + th10 + th11);
                        for (var j = 0; j < json.length; j++) {
                            {
                                if (json[j]["belated_interest"] === null){
                                    json[j]["belated_interest"] = json[j]["belated_interest"];
                                }
                                else {
                                    json[j]["belated_interest"] = parseInt(json[j]["belated_interest"]).toFixed(2);
                                }

                                if (json[j]["penal_interest"] === null){
                                    json[j]["penal_interest"] = json[j]["penal_interest"];
                                }
                                else {
                                    json[j]["penal_interest"] = parseInt(json[j]["penal_interest"]).toFixed(2);
                                }

                                if (json[j]["closing_balance_principal_due"] === null){
                                    json[j]["closing_balance_principal_due"] = json[j]["closing_balance_principal_due"];
                                }
                                else {
                                    json[j]["closing_balance_principal_due"] = parseInt(json[j]["closing_balance_principal_due"]).toFixed(2);
                                }

                                if (json[j]["closing_balance_interest_due"] === null){
                                    json[j]["closing_balance_interest_due"] = json[j]["closing_balance_interest_due"];
                                }
                                else {
                                    json[j]["closing_balance_interest_due"] = parseInt(json[j]["closing_balance_interest_due"]).toFixed(2);
                                }

                                if (moment().isAfter(moment(json[j]["demand_date"]))) {
                                    var cheque_date = moment(json[j]["cheque_date"]).format('YYYY-MM-DD');
                                }
                                else {
                                    cheque_date = 'Due Date Not Yet Crossed'
                                }

                                var demand_id = json[j]["_id"];
                                var penal_plus_belated = parseInt(json[j]["belated_interest"]) + parseInt(json[j]["penal_interest"]);
                                var url = '/updateDemand/'+demand_id+'/'+penal_plus_belated+'/'+json[j]["belated_interest"]+'/'+json[j]["penal_interest"];
                                var row = $('<tr></tr>').html('<td>' +
                                    +json[j]["demand_number"] +'</td>'+
                                    '<td>'+json[j]["demand_date"]+'</td>'+
                                    '<td>'+cheque_date+'</td>'+
                                    '<td>'+json[j]["loan_amount"]+'</td>'+
                                    '<td>'+json[j]["belated_interest"]+'</td>'+
                                    '<td>'+json[j]["penal_interest"]+'</td>'+
                                    '<td>'+json[j]["closing_balance_principal_due"]+'</td>'+
                                    '<td>'+json[j]["closing_balance_interest_due"]+'</td>'+
                                    '<td><button class="btn btn-default"><a href="' + url + '">'+ 'Update Demand' +'</a></button></td>'+
                                    '<td style="font-size: 10px">'+json[j]["Remarks"]+'</td>'+
                                    '<td><button onclick="downloadReceipt("'+json[j]+'")" class="btn btn-default">'+ 'Download Receipt' +'</button></td>');
                                $("#demandDetails").append(row);
                            }
                        }
                    }
                },
            error: function (e) {
                alert("error");
            }
        });

        function downloadReceipt(json) {
            if (json['penal_interest']) {

                if (json['loan_category'] === 'GTL (General Term Loan)') {
                    json['loan_category'] = "GTL";
                }
                else if (json['loan_category'] === 'NSS (New-Swarnima Scheme)') {
                    json['loan_category'] = "NSS";
                }
                else if (json['loan_category'] === 'MCG (Micro-Credit Gents)') {
                    json['loan_category'] = "MCR";
                }
                else if (json['loan_category'] === 'MSY (Mahila Samridhi Yojana)') {
                    json['loan_category'] = "MSY";
                }

                // Checking if the loan category is either Micro Credit or Mahila Samridhi Yojana

                doc.setFontSize(12);
                doc.text(75, 50, 'Receipt');

                var cheque_amount = json['principal_collected'] + json['interest_collected'] +
                    parseInt(json['penal_interest']) + parseInt(json['belated_interest']);

                doc.text(25, 65, 'Received with thanks from ' + json['district_bank'] + cheque_amount + ' Rs. ( ' + convertNumberToWords(cheque_amount) +
                    ' ) vide DD/Cheque No. ' + json['cheque_number'] + 'Dated: ' + json['cheque_date']);

                columns = ["Bank", "Ro #", "Code", "Principal", "Interest", "Penal", "Belated", "Service Charge", "Total"];

                rows.push([[json['district_bank']], json['ann_id'], json['loan_category'], [json['principal_collected']],
                    [json['interest_collected']], [parseInt(json['penal_interest'])], [parseInt(json['belated_interest'])],
                    [json['service_charge']], [cheque_amount]]);

                doc.autoTable(columns, rows, {startY: 90});

                table_end = doc.autoTableEndPosY();

                doc.text(25, doc.autoTableEndPosY() + 10, 'Prepared By:');
                doc.text(85, doc.autoTableEndPosY() + 10, 'Authorized Signatory');

                doc.text(25, table_end+30, 'To');
                doc.text(25, table_end+35, 'The Special Officer / Secretary,');
                var bank = json['district_bank'];
                doc.text(25, table_end+40, bank);
                doc.text(25, table_end+45, json['district']);

                doc.save('Receipt ' + json['ann_id'] + '.pdf');

            }
        }


        function convertNumberToWords(amount) {
    var words = new Array();
    words[0] = '';
    words[1] = 'One';
    words[2] = 'Two';
    words[3] = 'Three';
    words[4] = 'Four';
    words[5] = 'Five';
    words[6] = 'Six';
    words[7] = 'Seven';
    words[8] = 'Eight';
    words[9] = 'Nine';
    words[10] = 'Ten';
    words[11] = 'Eleven';
    words[12] = 'Twelve';
    words[13] = 'Thirteen';
    words[14] = 'Fourteen';
    words[15] = 'Fifteen';
    words[16] = 'Sixteen';
    words[17] = 'Seventeen';
    words[18] = 'Eighteen';
    words[19] = 'Nineteen';
    words[20] = 'Twenty';
    words[30] = 'Thirty';
    words[40] = 'Forty';
    words[50] = 'Fifty';
    words[60] = 'Sixty';
    words[70] = 'Seventy';
    words[80] = 'Eighty';
    words[90] = 'Ninety';
    amount = amount.toString();
    var atemp = amount.split(".");
    var number = atemp[0].split(",").join("");
    var n_length = number.length;
    var words_string = "";
    if (n_length <= 9) {
        var n_array = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0);
        var received_n_array = new Array();
        for (var i = 0; i < n_length; i++) {
            received_n_array[i] = number.substr(i, 1);
        }
        for (var i = 9 - n_length, j = 0; i < 9; i++, j++) {
            n_array[i] = received_n_array[j];
        }
        for (var i = 0, j = 1; i < 9; i++, j++) {
            if (i == 0 || i == 2 || i == 4 || i == 7) {
                if (n_array[i] == 1) {
                    n_array[j] = 10 + parseInt(n_array[j]);
                    n_array[i] = 0;
                }
            }
        }
        value = "";
        for (var i = 0; i < 9; i++) {
            if (i == 0 || i == 2 || i == 4 || i == 7) {
                value = n_array[i] * 10;
            } else {
                value = n_array[i];
            }
            if (value != 0) {
                words_string += words[value] + " ";
            }
            if ((i == 1 && value != 0) || (i == 0 && value != 0 && n_array[i + 1] == 0)) {
                words_string += "Crores ";
            }
            if ((i == 3 && value != 0) || (i == 2 && value != 0 && n_array[i + 1] == 0)) {
                words_string += "Lakhs ";
            }
            if ((i == 5 && value != 0) || (i == 4 && value != 0 && n_array[i + 1] == 0)) {
                words_string += "Thousand ";
            }
            if (i == 6 && value != 0 && (n_array[i + 1] != 0 && n_array[i + 2] != 0)) {
                words_string += "Hundred and ";
            } else if (i == 6 && value != 0) {
                words_string += "Hundred ";
            }
        }
        words_string = words_string.split("  ").join(" ");
    }
    return "[ Rupees "+words_string+" Only ]";
}


</script>

{% endblock %}
