{% extends "post_login_loans.html" %}
{% block content %}

<body>
    <div style="display: flex; flex-direction: row; justify-content: space-around; align-items: center; margin-top: 10px; margin-bottom: 10px">
        <div id="filters">
            <div id="Category">
                <label for="loanCategory">Loan Category</label>
                <select class="form-control" id="loanCategory" name="loanCategory">
                    {% set categories = ['All', 'GTL', 'NSS', 'MCL', 'MSY'] %}
                    {% for category in categories %}
                        <option value= "{{category}}">{{category}}</option>"
                    {% endfor %}
                </select>
                <label for="DistrictSelect" style="margin-left: 6%">Service District:</label>
                <select id="DistrictSelect" style="margin-left: 1%; position: relative;">
                    {% set districts = ['Ariyalur', 'Karur', 'Nagapattinam', 'Perambalur',
                      'Pudukkottai', 'Thanjavur', 'Tiruchirappalli','Tiruvarur', 'Dharmapuri',
                      'Coimbatore', 'Erode', 'Krishnagiri', 'Namakkal', 'Nilgiris', 'Salem',
                      'Tiruppur', 'Dindigul', 'Kanyakumari', 'Madurai', 'Ramanathapuram', 'Sivaganga',
                      'Theni', 'Thoothukudi','Tirunelveli', 'Virudhunagar', 'Chennai', 'Cuddalore', 'Kancheepuram',
                      'Tiruvallur', 'Tiruvannamalai', 'Vellore','Viluppuram'] %}

                    {% for district in districts %}
                        <option value= "{{district}}">{{district}}</option>"
                    {% endfor %}
                </select>
            </div>
        </div>

        <div id="Search" style="display: flex; flex-direction: column;">
            <label for="myInput" style="margin-left: 10%">Search by File Number:</label>
            <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for names.." title="Type in a name">
        </div>
    </div>

    <div id="loansList">
    </div>
</body>

<script>
        var source = "/raw_demands";
        $.ajax({
            type: 'GET',
            url: source,
            contentType: "application/json",
            dataType: 'json',
            success: function (json) {
                    if(json[0]['loan_category'] === 'GTL (General Term Loan)') {
                        var cat = "GTL";
                    }
                    else if(json[0]['loan_category'] === 'NSS (New-Swarnima Scheme)') {
                        cat = "NSS";
                    }
                    else if(json[0]['loan_category'] === 'MCG (Micro-Credit Gents)') {
                        cat = "MCR";
                    }
                    else if(json[0]['loan_category'] === 'MSY (Mahila Samridhi Yojana)') {
                        cat = "MSY";
                    }

                        var $accountHead = $("#loanCategory");

                        $accountHead.each(function() {
                            if (this.selectedIndex === 0) {
                                populatePage(json);
                            }
                        });

                        $accountHead.change(function () {
                            var selectedbucket = this.value;
                            //filter based on  selected year.
                            if (selectedbucket==="All") {
                                populatePage(json);
                            }
                            else {
                                selectedAccountHead = jQuery.grep(json, function (account) {
                                    return account.loan_category === selectedbucket;
                                });
                                populatePage(selectedAccountHead);
                            }
                        });

                        function populatePage(jsonFunc) {
                            $("#loansDetails").find("tbody").empty();
                            var tbl = $("<table class='table table-bordered table-dark' id='loansDetails'/>");
                            $("#loansList").append(tbl);
                            var hr = "<tr>";
                            var th1 = "<th style='text-align:center;vertical-align:middle'>" + "Ro Number" + "</th>";
                            var th2 = "<th style='text-align:center;vertical-align:middle'>" + "File #" + "</th>";
                            var th3 = "<th style='text-align:center;vertical-align:middle'>" + "Demand Number" + "</th>";
                            var th4 = "<th style='text-align:center;vertical-align:middle'>" + "Demand Date" + "</th>";
                            var th5 = "<th style='text-align:center;vertical-align:middle'>" + "Cheque Number" + "</th>";
                            var th6 = "<th style='text-align:center;vertical-align:middle'>" + "Download Receipt" + "</th>";
                            $("#loansDetails").append(hr + th1 + th2 + th3 + th4 + th5 + th6);
                            for (var j = 0; j < jsonFunc.length; j++) {
                                {
                                    var loan_id = jsonFunc[j]["ro_number"];
                                    var ann_loan_id = jsonFunc[j]["ann_id"];
                                    var cheque_number = jsonFunc[j]["cheque_number"];
                                    var row = $('<tr></tr>').html('<td>' + loan_id + '</td>'+
                                        '<td>'+ ann_loan_id + '</td>'+
                                        '<td>'+jsonFunc[j]["demand_number"] +'</td>'+
                                        '<td>'+ moment(jsonFunc[j]["demand_date"]).format("DD-MM-YYYY") +'</td>'+
                                        '<td>'+jsonFunc[j]["cheque_number"] +'</td>'+
                                        '<td><button onclick="downloadReceipt('+cheque_number+')" class="btn btn-default">'+ 'Download Receipt' +'</button></td>');
                                    $("#loansDetails").append(row);
                                }
                            }
                        }
                },
            error: function (e) {
                alert("error");
            }
        });

    function myFunction() {
        var input, filter, table, tr, td, i;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("loansList");
        tr = table.getElementsByTagName("tr");
        console.log(tr.length);
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1];
            if (td) {
                if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

        function downloadReceipt(cheque_number) {
        console.log(cheque_number);
        var source = "/raw_demands_by_cheque_number/"+cheque_number;
        var doc = new jsPDF();
        $.ajax({
            type: 'GET',
            url: source,
            contentType: "application/json",
            dataType: 'json',
            success: function (json) {

                doc.setFontSize(12);
                doc.text(30, 25, 'TAMILNADU BACKWARD CLASSES ECONOMIC DEVELOPMENT CORPORATION LTD');
                doc.setFontSize(10);
                doc.text(40, 30, '1/1 (1) Mayor Ramanathan Salai (East) Gendu Reddy Subway, Egmore, Chennai - 600008');
                doc.text(40, 35, 'Phone Office: 044-28190122, 044-28190146');
                doc.text(160, 35, 'Email: tabcedco@gmail.com');

                doc.setFontSize(12);
                doc.text(75, 50, 'RECEIPT');

                var cheque_amount = 0;

                for(var j = 0; j < json.length; j++) {
                    cheque_amount += parseInt(json[j]['cheque_amount']);
                }

                console.log(json);

                var AAO = doc.splitTextToSize('Received with thanks from ' + json[0]['district_bank'] + ' ' + cheque_amount + ' Rs. ( ' + convertNumberToWords(cheque_amount) +
                    ' ) vide DD/Cheque No. ' + json[j]['cheque_number'] + 'Dated: ' + moment(json[j]['cheque_date']['$date']).format('DD/MM/YYYY'), 160);

                doc.text(25, 65, AAO);

                for(j = 0; j < json.length; j++) {
                    if (json[j]['penal_interest']) {
                        if(json[0]['loan_category'] === 'GTL (General Term Loan)') {
                            var cat = "GTL";
                        }
                        else if(json[0]['loan_category'] === 'NSS (New-Swarnima Scheme)') {
                            cat = "NSS";
                        }
                        else if(json[0]['loan_category'] === 'MCG (Micro-Credit Gents)') {
                            cat = "MCR";
                        }
                        else if(json[0]['loan_category'] === 'MSY (Mahila Samridhi Yojana)') {
                            cat = "MSY";
                        }

                        var loan_id = json[j]["ro_number"];
                        // Checking if the loan category is either Micro Credit or Mahila Samridhi Yojana

                        var columns = ["Bank", "Ro #", "Code", "Principal", "Interest", "Penal", "Belated", "Service Charge", "Total"];
                        var rows=[];

                        var principal = json[j]['principal_collected'] + json[j]['service_charge'];

                        rows.push([[json[j]['district_bank']], json[j]['ro_number'], json[j]['loan_category'], [principal],
                            [json[j]['interest_collected']], [parseInt(json[j]['penal_interest'])], [parseInt(json[j]['belated_interest'])],
                            [json[j]['service_charge']], [json[j]['cheque_amount']]]);

                    }
                    else {
                        alert('Demand not yet updated!');
                    }
                        rows.push([["-"], ["-"], ["-"], ["-"],
                            ["-"], ["-"], ["-"], ["-"], [cheque_amount]]);

                        doc.autoTable(columns, rows,
                            {
                                startY: 90,
                                styles: {overflow: 'linebreak', fontSize: 8},
                                columnStyles: {0: {columnWidth: 30}, 1: {columnWidth: 30}}
                            });

                        var table_end = doc.autoTableEndPosY();

                        doc.text(25, doc.autoTableEndPosY() + 10, 'Prepared By:');
                        doc.text(155, doc.autoTableEndPosY() + 10, 'Authorized Signatory');

                        doc.text(25, table_end+30, 'To');
                        doc.text(25, table_end+35, 'The Special Officer / Secretary,');
                        var bank = json[j]['district_bank'];
                        doc.text(25, table_end+40, bank);
                        doc.text(25, table_end+45, json[j]['district']);

                        doc.save('Receipt ' + json[j]['ann_id'] + '.pdf');
                }
            },
            error: function (e) {
                alert("error");
            }
        });
    }

    function convertNumberToWords(amount) {
    var words = new Array();
    words[0] = '';
    words[1] = 'One';
    words[2] = 'Two';
    words[3] = 'Three';
    words[4] = 'Four';
    words[5] = 'Five';
    words[6] = 'Six';
    words[7] = 'Seven';
    words[8] = 'Eight';
    words[9] = 'Nine';
    words[10] = 'Ten';
    words[11] = 'Eleven';
    words[12] = 'Twelve';
    words[13] = 'Thirteen';
    words[14] = 'Fourteen';
    words[15] = 'Fifteen';
    words[16] = 'Sixteen';
    words[17] = 'Seventeen';
    words[18] = 'Eighteen';
    words[19] = 'Nineteen';
    words[20] = 'Twenty';
    words[30] = 'Thirty';
    words[40] = 'Forty';
    words[50] = 'Fifty';
    words[60] = 'Sixty';
    words[70] = 'Seventy';
    words[80] = 'Eighty';
    words[90] = 'Ninety';
    amount = amount.toString();
    var atemp = amount.split(".");
    var number = atemp[0].split(",").join("");
    var n_length = number.length;
    var words_string = "";
    if (n_length <= 9) {
        var n_array = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0);
        var received_n_array = new Array();
        for (var i = 0; i < n_length; i++) {
            received_n_array[i] = number.substr(i, 1);
        }
        for (var i = 9 - n_length, j = 0; i < 9; i++, j++) {
            n_array[i] = received_n_array[j];
        }
        for (var i = 0, j = 1; i < 9; i++, j++) {
            if (i == 0 || i == 2 || i == 4 || i == 7) {
                if (n_array[i] == 1) {
                    n_array[j] = 10 + parseInt(n_array[j]);
                    n_array[i] = 0;
                }
            }
        }
        value = "";
        for (var i = 0; i < 9; i++) {
            if (i == 0 || i == 2 || i == 4 || i == 7) {
                value = n_array[i] * 10;
            } else {
                value = n_array[i];
            }
            if (value != 0) {
                words_string += words[value] + " ";
            }
            if ((i == 1 && value != 0) || (i == 0 && value != 0 && n_array[i + 1] == 0)) {
                words_string += "Crores ";
            }
            if ((i == 3 && value != 0) || (i == 2 && value != 0 && n_array[i + 1] == 0)) {
                words_string += "Lakhs ";
            }
            if ((i == 5 && value != 0) || (i == 4 && value != 0 && n_array[i + 1] == 0)) {
                words_string += "Thousand ";
            }
            if (i == 6 && value != 0 && (n_array[i + 1] != 0 && n_array[i + 2] != 0)) {
                words_string += "Hundred and ";
            } else if (i == 6 && value != 0) {
                words_string += "Hundred ";
            }
        }
        words_string = words_string.split("  ").join(" ");
    }
    return "[ Rupees "+words_string+" Only ]";
}

</script>

{% endblock %}
